<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ASM Gest√£o Cl√≠nica</title>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<!-- jsPDF para gera√ß√£o de PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,sans-serif;background:#f0f2f5}
.login-container{display:flex;justify-content:center;align-items:center;min-height:100vh;background:linear-gradient(135deg,#264653 0%,#2a9d8f 100%)}
.login-box{background:white;padding:40px;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,0.2);width:90%;max-width:400px;text-align:center}
.login-box h1{color:#264653;margin-bottom:10px;font-size:28px}
.login-box h2{color:#666;font-size:18px;margin-bottom:30px;font-weight:normal}
.login-box .form-group{margin-bottom:20px;text-align:left}
.login-box input{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:16px}
.login-btn{width:100%;padding:14px;background:#2a9d8f;color:white;border:none;border-radius:8px;font-size:16px;cursor:pointer}
.login-error{color:#e76f51;margin-top:15px;display:none}
.header{background:#264653;color:white;padding:15px;text-align:center}
.user-bar{background:#1a3a47;color:white;padding:10px 20px;display:flex;justify-content:space-between;align-items:center}
.user-bar button{background:rgba(255,255,255,0.2);border:none;color:white;padding:5px 15px;border-radius:5px;cursor:pointer}
.nav{display:flex;justify-content:center;gap:10px;padding:10px;background:#2a9d8f;flex-wrap:wrap}
.nav button{padding:10px 20px;border:none;background:rgba(255,255,255,0.2);color:white;border-radius:5px;cursor:pointer}
.nav button:hover,.nav button.active{background:white;color:#264653}
.container{max-width:1200px;margin:20px auto;padding:0 20px}
.section{display:none;background:white;padding:20px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
.section.active{display:block}
.btn{padding:10px 20px;border:none;border-radius:5px;cursor:pointer;font-size:14px;margin:5px}
.btn-primary{background:#2a9d8f;color:white}
.btn-success{background:#52b788;color:white}
.btn-danger{background:#e76f51;color:white}
.btn-whatsapp{background:#25d366;color:white}
.btn-warning{background:#f4a261;color:white}
.form-group{margin-bottom:15px}
.form-group label{display:block;margin-bottom:5px;font-weight:bold}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:5px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;margin-top:20px}
.card{background:white;padding:15px;border-radius:8px;border:2px solid #e2e8f0;cursor:pointer}
.card:hover{border-color:#2a9d8f;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.1)}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;margin-top:20px}
.calendar-header{text-align:center;font-weight:bold;padding:10px;background:#264653;color:white}
.calendar-day{background:#f8f9fa;min-height:100px;padding:10px;border-radius:5px;cursor:pointer}
.appointment{background:#2a9d8f;color:white;padding:5px;margin:2px 0;border-radius:3px;font-size:12px;display:flex;justify-content:space-between}
.appointment.cancelled{background:#adb5bd;text-decoration:line-through;opacity:0.7}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:1000}
.modal.active{display:flex}
.modal-content{background:white;padding:30px;border-radius:10px;width:90%;max-width:500px;max-height:90vh;overflow-y:auto}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.close-btn{background:none;border:none;font-size:24px;cursor:pointer;color:#666}
table{width:100%;border-collapse:collapse;margin-top:20px}
th,td{padding:12px;text-align:left;border-bottom:1px solid #ddd}
th{background:#f8f9fa}
.summary-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:20px}
.summary-card{padding:20px;border-radius:10px;text-align:center;color:white}
.summary-card.green{background:#52b788}
.summary-card.red{background:#e76f51}
.summary-card.blue{background:#264653}
.tabs{display:flex;gap:10px;margin-bottom:20px;border-bottom:2px solid #ddd;flex-wrap:wrap}
.tab{padding:10px 20px;background:none;border:none;cursor:pointer}
.tab.active{color:#2a9d8f;border-bottom:2px solid #2a9d8f}
.tab-content{display:none}
.tab-content.active{display:block}
.settings-box{background:#e8f4f8;padding:20px;border-radius:8px;margin-bottom:20px;border-left:4px solid #264653}
.footer{text-align:center;padding:20px;background:#264653;color:white;margin-top:40px;font-size:12px}
.session-checkbox{margin-right:10px;transform:scale(1.2)}
.session-row{cursor:pointer}
.session-row:hover{background:#f0f8ff}
.session-row.selected{background:#e0f2f1}
.report-box{background:#f8f9fa;padding:20px;border-radius:8px;white-space:pre-wrap;font-family:monospace;margin:20px 0;max-height:400px;overflow-y:auto}
.financial-row{cursor:pointer}
.financial-row:hover{background:#f0f8ff}
.financial-row.selected{background:#e0f2f1}

/* TELA DE ATIVA√á√ÉO */
.activation-container{display:none;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:20px;background:linear-gradient(135deg,#264653 0%,#2a9d8f 100%)}
.activation-box{background:white;padding:40px;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,0.2);width:90%;max-width:400px;text-align:center}
.activation-box h2{color:#264653;margin-bottom:15px}
.activation-box p{color:#666;margin-bottom:25px}
.code-input{width:100%;padding:15px;font-size:20px;text-align:center;letter-spacing:3px;border:2px solid #ddd;border-radius:8px;margin-bottom:20px;text-transform:uppercase}
.cpf-input{width:100%;padding:15px;font-size:18px;text-align:center;border:2px solid #ddd;border-radius:8px;margin-bottom:20px}
.activation-error{color:#e76f51;margin-top:10px;display:none}
.activation-success{color:#52b788;margin-top:10px;display:none}
.loading{display:inline-block;width:20px;height:20px;border:3px solid #f3f3f3;border-top:3px solid #264653;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
</style>
</head>
<body>

<!-- TELA DE ATIVA√á√ÉO -->
<div id="activationScreen" class="activation-container" style="display:flex">
<div class="activation-box">
<h1>üè• ASM Gest√£o Cl√≠nica</h1>
<h2>Ativa√ß√£o do Sistema</h2>
<div class="form-group" style="text-align:left">
<label>CPF</label>
<input type="text" class="cpf-input" id="activationCPF" placeholder="000.000.000-00" maxlength="14">
</div>
<div class="form-group" style="text-align:left">
<label>C√≥digo de Ativa√ß√£o</label>
<input type="text" class="code-input" id="activationCode" placeholder="XXXX-XXXX" maxlength="9">
</div>
<button class="login-btn" id="activateBtn" onclick="activateSystem()">Ativar Sistema</button>
<div class="activation-error" id="activationError"></div>
<div class="activation-success" id="activationSuccess">Sistema ativado com sucesso!</div>
<div id="activationLoading" style="display:none;margin-top:15px">
<div class="loading"></div>
<p style="margin-top:10px;color:#666">Verificando...</p>
</div>
</div>
</div>

<!-- SISTEMA PRINCIPAL -->
<div id="mainSystem" style="display:none">
<div class="header">
<h1>üè• ASM Gest√£o Cl√≠nica</h1>
<p id="headerSubtitle">Sistema de Gest√£o para Fisioterapeutas</p>
</div>

<div class="user-bar">
<div>üë§ <span id="currentUserName">Profissional</span></div>
<div><button onclick="logout()">üö™ Sair</button></div>
</div>

<div class="nav">
<button class="active" onclick="showSection('agenda')">üìÖ Agenda</button>
<button onclick="showSection('pacientes')">üë• Pacientes</button>
<button onclick="showSection('financeiro')">üí∞ Financeiro</button>
<button onclick="showSection('fluxo')">üìä Fluxo de Caixa</button>
<button onclick="showSection('relatorios')">üìà Relat√≥rios</button>
<button onclick="showSection('configuracoes')">‚öôÔ∏è Configura√ß√µes</button>
</div>

<div class="container">

<div id="configuracoes" class="section">
<h2>‚öôÔ∏è Configura√ß√µes</h2>
<div class="settings-box">
<div class="form-group"><label>Nome do Profissional *</label><input type="text" id="configName"></div>
<div class="form-group"><label>CREFITO *</label><input type="text" id="configCrefito"></div>
<div class="form-group"><label>Cl√≠nica (opcional)</label><input type="text" id="configClinic"></div>
<div class="form-group"><label>Chave Pix</label><input type="text" id="configPix"></div>
<button class="btn btn-primary" onclick="saveConfig()">üíæ Salvar</button>
</div>
</div>

<div id="agenda" class="section active">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
<h2>Agenda</h2>
<button class="btn btn-primary" onclick="openAppointmentModal()">+ Novo</button>
</div>
<div style="display:flex;justify-content:center;gap:20px;margin-bottom:20px">
<button class="btn btn-primary" onclick="changeMonth(-1)">‚Üê</button>
<h3 id="currentMonth"></h3>
<button class="btn btn-primary" onclick="changeMonth(1)">‚Üí</button>
</div>
<div class="calendar" id="calendar"></div>
</div>

<div id="pacientes" class="section">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
<h2>Pacientes</h2>
<button class="btn btn-primary" onclick="openPatientModal()">+ Novo</button>
</div>
<input type="text" style="width:100%;padding:10px;margin-bottom:20px" placeholder="Buscar..." oninput="searchPatients(this.value)">
<div class="grid" id="patientsList"></div>
</div>

<div id="financeiro" class="section">
<h2>Financeiro</h2>
<div class="summary-cards">
<div class="summary-card green"><h3 id="totalReceived">R$ 0,00</h3><p>Recebido</p></div>
<div class="summary-card red"><h3 id="totalPending">R$ 0,00</h3><p>A Receber</p></div>
<div class="summary-card blue"><h3 id="totalSessions">0</h3><p>Sess√µes</p></div>
</div>
<div style="margin-bottom:15px">
<button class="btn btn-whatsapp" onclick="sendSelectedPendingWhatsApp()" id="btnCobrarSelecionados" style="display:none">
üì± Cobrar Selecionados (<span id="selectedCount">0</span>)
</button>
<button class="btn btn-primary" onclick="selectAllPending()">Selecionar Todos Pendentes</button>
<button class="btn btn-warning" onclick="clearSelection()">Limpar Sele√ß√£o</button>
</div>
<table>
<thead>
<tr>
<th><input type="checkbox" id="selectAllFinancial" onchange="toggleAllFinancial()"></th>
<th>Paciente</th>
<th>Data</th>
<th>Servi√ßo</th>
<th>Valor</th>
<th>Status</th>
<th>A√ß√µes</th>
</tr>
</thead>
<tbody id="financialTable"></tbody>
</table>
</div>

<div id="fluxo" class="section">
<h2>Fluxo de Caixa</h2>
<div class="form-group"><label>M√™s/Ano</label><input type="month" id="cashFlowMonth" onchange="renderCashFlow()"></div>
<div class="summary-cards">
<div class="summary-card green"><h3 id="cfEntries">R$ 0,00</h3><p>Entradas</p></div>
<div class="summary-card red"><h3 id="cfExits">R$ 0,00</h3><p>Sa√≠das</p></div>
<div class="summary-card blue"><h3 id="cfBalance">R$ 0,00</h3><p>Saldo</p></div>
</div>
<div class="tabs">
<button class="tab active" onclick="showCashFlowTab('entries')">Entradas</button>
<button class="tab" onclick="showCashFlowTab('exits')">Despesas</button>
</div>
<div id="cfEntriesTab" class="tab-content active">
<table><thead><tr><th>Data</th><th>Paciente</th><th>Servi√ßo</th><th>Valor</th></tr></thead><tbody id="entriesTable"></tbody></table>
</div>
<div id="cfExitsTab" class="tab-content">
<table><thead><tr><th>Data</th><th>Descri√ß√£o</th><th>Categoria</th><th>Valor</th><th>A√ß√µes</th></tr></thead><tbody id="exitsTable"></tbody></table>
</div>
</div>

<div id="relatorios" class="section">
<h2>Relat√≥rios</h2>
<div class="form-group"><label>M√™s/Ano</label><input type="month" id="reportMonth" onchange="renderReports()"></div>
<div class="summary-cards">
<div class="summary-card blue"><h3 id="reportSessions">0</h3><p>Atendimentos</p></div>
<div class="summary-card green"><h3 id="reportRevenue">R$ 0,00</h3><p>Faturamento</p></div>
</div>
<table><thead><tr><th>Paciente</th><th>Sess√µes</th><th>Total</th></tr></thead>
<tbody id="reportTable"></tbody>
</table>
</div>

</div>

<div class="modal" id="appointmentModal">
<div class="modal-content">
<div class="modal-header"><h3>Agendamento</h3><button class="close-btn" onclick="closeModal('appointmentModal')">&times;</button></div>
<div class="form-group"><label>Paciente *</label><select id="apptPatient"></select></div>
<div class="form-group"><label>Data *</label><input type="date" id="apptDate"></div>
<div class="form-group"><label>Hor√°rio *</label><input type="time" id="apptTime"></div>
<div class="form-group"><label>Tipo</label><select id="apptType"><option value="normal">Normal</option><option value="laser">Laser</option><option value="avaliacao">Avalia√ß√£o</option></select></div>
<div class="form-group"><label>Valor (R$)</label><input type="number" id="apptValue" step="0.01"></div>
<div class="form-group"><label>Observa√ß√µes</label><textarea id="apptNotes" rows="3"></textarea></div>
<div style="display:flex;gap:10px">
<button class="btn btn-whatsapp" id="btnWhatsAppt" onclick="sendAppointmentWhatsApp()" style="display:none">üì± WhatsApp</button>
<button class="btn btn-warning" id="btnToggleCancel" onclick="toggleCancelAppointment()" style="display:none">‚ùå Cancelar</button>
<button class="btn btn-primary" onclick="saveAppointment()" style="margin-left:auto">Salvar</button>
</div>
</div>
</div>

<div class="modal" id="patientModal">
<div class="modal-content" style="max-width:700px">
<div class="modal-header"><h3 id="patientModalTitle">Novo Paciente</h3><button class="close-btn" onclick="closeModal('patientModal')">&times;</button></div>
<div class="tabs">
<button class="tab active" onclick="showPatientTab('info')">Informa√ß√µes</button>
<button class="tab" onclick="showPatientTab('financeiro')">Financeiro</button>
<button class="tab" onclick="showPatientTab('evolucao')">Evolu√ß√£o</button>
<button class="tab" onclick="showPatientTab('relatorio')">Relat√≥rio</button>
</div>

<div id="tabInfo" class="tab-content active">
<input type="hidden" id="patientId">
<div class="form-group"><label>Nome *</label><input type="text" id="patientName"></div>
<div class="form-group"><label>Telefone *</label><input type="tel" id="patientPhone" placeholder="(00) 00000-0000"></div>
<div class="form-group"><label>E-mail</label><input type="email" id="patientEmail"></div>
<div class="form-group"><label>Valor Padr√£o</label><input type="number" id="patientValue" step="0.01"></div>
<div class="form-group"><label>Queixa</label><textarea id="patientComplaint" rows="3"></textarea></div>
</div>

<div id="tabFinanceiro" class="tab-content">
<div class="summary-cards">
<div class="summary-card green"><h3 id="patientPaid">R$ 0,00</h3><p>Pago</p></div>
<div class="summary-card red"><h3 id="patientPending">R$ 0,00</h3><p>Pendente</p></div>
</div>
<div style="margin-bottom:15px">
<button class="btn btn-whatsapp" onclick="sendPendingSessionsWhatsApp()">üì± Cobrar Selecionadas</button>
</div>
<table>
<thead>
<tr>
<th><input type="checkbox" id="selectAllSessions" onchange="toggleAllSessions()"></th>
<th>Data</th><th>Servi√ßo</th><th>Valor</th><th>Status</th><th>A√ß√µes</th>
</tr>
</thead>
<tbody id="patientFinanceTable"></tbody>
</table>
</div>

<div id="tabEvolucao" class="tab-content">
<div class="form-group">
<label>Nova Evolu√ß√£o</label>
<textarea id="newEvolution" rows="4" placeholder="Descreva..."></textarea>
<button class="btn btn-primary" onclick="addEvolution()">Salvar</button>
</div>
<div id="evolutionsList"></div>
</div>

<div id="tabRelatorio" class="tab-content">
<div class="form-group"><label>M√™s/Ano</label><input type="month" id="reportMonthPatient"></div>
<button class="btn btn-primary" onclick="generatePatientReport()">Gerar Relat√≥rio</button>
<div id="reportContainer" style="display:none;margin-top:20px">
<div class="report-box" id="reportContent"></div>
<button class="btn btn-primary" onclick="copyReport()">Copiar</button>
<button class="btn btn-whatsapp" onclick="sendReportWhatsApp()">üì± WhatsApp</button>
<button class="btn btn-success" onclick="generatePatientReportPDF()">üìÑ PDF</button>
</div>
</div>

<div style="display:flex;justify-content:space-between;margin-top:20px">
<button class="btn btn-danger" id="btnDeletePatient" onclick="deletePatient()">Excluir</button>
<button class="btn btn-primary" onclick="savePatient()">Salvar</button>
</div>
</div>
</div>

<div class="modal" id="expenseModal">
<div class="modal-content">
<div class="modal-header"><h3>Nova Despesa</h3><button class="close-btn" onclick="closeModal('expenseModal')">&times;</button></div>
<div class="form-group"><label>Data *</label><input type="date" id="expenseDate"></div>
<div class="form-group"><label>Descri√ß√£o *</label><input type="text" id="expenseDesc"></div>
<div class="form-group"><label>Categoria</label><select id="expenseCategory"><option value="material">Material</option><option value="aluguel">Aluguel</option><option value="servicos">Servi√ßos</option><option value="outros">Outros</option></select></div>
<div class="form-group"><label>Valor (R$) *</label><input type="number" id="expenseValue" step="0.01"></div>
<button class="btn btn-primary" onclick="saveExpense()">Salvar</button>
</div>
</div>

<div class="footer">
<p><strong>ASM Gest√£o Cl√≠nica</strong></p>
<p>¬© 2024 Dra. Andresa Augusto - Todos os direitos reservados</p>
<p>Proibida reprodu√ß√£o sem autoriza√ß√£o</p>
</div>
</div>

<script>
// ============================================
// CONFIGURA√á√ÉO DO FIREBASE
// ============================================
const firebaseConfig = {
  apiKey: "AIzaSyDAP8Krf1QYRUf2VmgeGRXL6eoceVcDnp4",
  authDomain: "asm-gestao-clinica.firebaseapp.com",
  databaseURL: "https://asm-gestao-clinica-default-rtdb.firebaseio.com",
  projectId: "asm-gestao-clinica",
  storageBucket: "asm-gestao-clinica.firebasestorage.app",
  messagingSenderId: "846179775289",
  appId: "1:846179775289:web:b914c4e024b1fb13a66ee8"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// ============================================
// SISTEMA DE ATIVA√á√ÉO VIA FIREBASE
// ============================================

// M√°scara de CPF
document.getElementById('activationCPF').addEventListener('input', function(e) {
  let value = e.target.value.replace(/\D/g, '');
  if (value.length <= 11) {
    value = value.replace(/(\d{3})(\d)/, '$1.$2');
    value = value.replace(/(\d{3})(\d)/, '$1.$2');
    value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    e.target.value = value;
  }
});

// Hash simples do CPF (para n√£o armazenar em texto puro)
function hashCPF(cpf) {
  // Remove caracteres n√£o num√©ricos
  const cleanCPF = cpf.replace(/\D/g, '');
  // Cria um hash simples usando btoa (base64) + salt
  const salt = 'ASM_GESTAO_2024';
  let hash = 0;
  const str = cleanCPF + salt;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }
  return Math.abs(hash).toString(16) + btoa(cleanCPF).substring(0, 8);
}

// Verificar se j√° est√° ativado ao carregar
window.onload = function() {
  const savedActivation = localStorage.getItem('asm_activation');
  if (savedActivation) {
    const activationData = JSON.parse(savedActivation);
    // Verifica se a ativa√ß√£o ainda √© v√°lida no Firebase
    validateStoredActivation(activationData);
  }
};

async function validateStoredActivation(activationData) {
  try {
    const snapshot = await database.ref('activationCodes/' + activationData.code).once('value');
    const codeData = snapshot.val();
    
    if (codeData && codeData.active && codeData.cpfHash === activationData.cpfHash) {
      // Ativa√ß√£o v√°lida, entra no sistema
      showMainSystem();
    } else {
      // Ativa√ß√£o inv√°lida ou expirada, limpa localStorage
      localStorage.removeItem('asm_activation');
    }
  } catch (error) {
    console.error('Erro ao validar ativa√ß√£o:', error);
    // Em caso de erro de conex√£o, permite acesso offline se j√° estava ativado
    if (activationData) {
      showMainSystem();
    }
  }
}

async function activateSystem() {
  const cpf = document.getElementById('activationCPF').value.trim();
  const code = document.getElementById('activationCode').value.toUpperCase().trim();
  const errorMsg = document.getElementById('activationError');
  const successMsg = document.getElementById('activationSuccess');
  const loading = document.getElementById('activationLoading');
  const btn = document.getElementById('activateBtn');
  
  errorMsg.style.display = 'none';
  successMsg.style.display = 'none';
  
  // Valida√ß√µes b√°sicas
  if (!cpf || cpf.length < 14) {
    showActivationError('Digite um CPF v√°lido!');
    return;
  }
  
  if (!code || code.length < 8) {
    showActivationError('Digite um c√≥digo de ativa√ß√£o v√°lido!');
    return;
  }
  
  loading.style.display = 'block';
  btn.disabled = true;
  
  try {
    // Busca o c√≥digo no Firebase
    const snapshot = await database.ref('activationCodes/' + code).once('value');
    const codeData = snapshot.val();
    
    if (!codeData) {
      showActivationError('C√≥digo de ativa√ß√£o n√£o encontrado!');
      return;
    }
    
    if (!codeData.active) {
      showActivationError('Este c√≥digo foi desativado!');
      return;
    }
    
    const cpfHash = hashCPF(cpf);
    
    if (codeData.cpfHash) {
      // C√≥digo j√° vinculado a um CPF
      if (codeData.cpfHash !== cpfHash) {
        showActivationError('Este c√≥digo j√° est√° vinculado a outro CPF!');
        return;
      }
      // Mesmo CPF, permite acesso
    } else {
      // Primeira ativa√ß√£o - vincula CPF ao c√≥digo
      await database.ref('activationCodes/' + code).update({
        cpfHash: cpfHash,
        activatedAt: new Date().toISOString()
      });
    }
    
    // Salva ativa√ß√£o localmente
    const activationData = {
      code: code,
      cpfHash: cpfHash,
      activatedAt: new Date().toISOString()
    };
    localStorage.setItem('asm_activation', JSON.stringify(activationData));
    
    successMsg.style.display = 'block';
    
    setTimeout(() => {
      showMainSystem();
    }, 1000);
    
  } catch (error) {
    console.error('Erro:', error);
    showActivationError('Erro de conex√£o. Verifique sua internet e tente novamente.');
  } finally {
    loading.style.display = 'none';
    btn.disabled = false;
  }
}

function showActivationError(msg) {
  const errorDiv = document.getElementById('activationError');
  errorDiv.textContent = msg;
  errorDiv.style.display = 'block';
  document.getElementById('activationLoading').style.display = 'none';
  document.getElementById('activateBtn').disabled = false;
}

function showMainSystem() {
  document.getElementById('activationScreen').style.display = 'none';
  document.getElementById('mainSystem').style.display = 'block';
  
  loadUserData();
  initializeApp();
}

function logout() {
  localStorage.removeItem('asm_activation');
  location.reload();
}

// ============================================
// FUN√á√ïES DO SISTEMA (INALTERADAS)
// ============================================

let config={},patients=[],appointments=[],evolutions=[],expenses=[];
let currentDate=new Date(),currentPatientId=null,currentApptId=null,currentReport='';
let selectedSessions=new Set();
let selectedFinancial=new Set();

function loadUserData(){
  config=JSON.parse(localStorage.getItem('asm_config'))||{professionalName:'',crefito:'',clinicName:'ASM Fisioterapia',pix:''};
  patients=JSON.parse(localStorage.getItem('asm_patients'))||[];
  appointments=JSON.parse(localStorage.getItem('asm_appointments'))||[];
  evolutions=JSON.parse(localStorage.getItem('asm_evolutions'))||[];
  expenses=JSON.parse(localStorage.getItem('asm_expenses'))||[];
}

function saveUserData(){
  localStorage.setItem('asm_config',JSON.stringify(config));
  localStorage.setItem('asm_patients',JSON.stringify(patients));
  localStorage.setItem('asm_appointments',JSON.stringify(appointments));
  localStorage.setItem('asm_evolutions',JSON.stringify(evolutions));
  localStorage.setItem('asm_expenses',JSON.stringify(expenses));
}

function initializeApp(){
  loadConfig();
  renderCalendar();
  renderPatients();
  updateFinancialSummary();
  loadPatientSelect();
  const today=new Date().toISOString().slice(0,7);
  document.getElementById('cashFlowMonth').value=today;
  document.getElementById('reportMonth').value=today;
}

function loadConfig(){
  document.getElementById('configName').value=config.professionalName;
  document.getElementById('configCrefito').value=config.crefito;
  document.getElementById('configClinic').value=config.clinicName;
  document.getElementById('configPix').value=config.pix||'';
  updateHeader();
}

function saveConfig(){
  config.professionalName=document.getElementById('configName').value.trim();
  config.crefito=document.getElementById('configCrefito').value.trim();
  config.clinicName=document.getElementById('configClinic').value.trim()||'ASM Fisioterapia';
  config.pix=document.getElementById('configPix').value.trim();
  if(!config.professionalName||!config.crefito){alert('Preencha nome e CREFITO!');return}
  saveUserData();
  updateHeader();
  alert('Configura√ß√µes salvas!');
}

function updateHeader(){
  const subtitle=document.getElementById('headerSubtitle');
  subtitle.textContent=config.professionalName?config.professionalName+' - CREFITO '+config.crefito:'Configure seus dados';
}

function getProfessionalSignature(){
  return{name:config.professionalName||'Profissional',crefito:config.crefito?'CREFITO '+config.crefito:'',clinic:config.clinicName||'ASM Fisioterapia',pix:config.pix||''};
}

function showSection(section){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
  document.getElementById(section).classList.add('active');
  event.target.classList.add('active');
  if(section==='financeiro'){selectedFinancial.clear();renderFinancialTable();}
  if(section==='fluxo')renderCashFlow();
  if(section==='relatorios')renderReports();
}

// ============================================
// FINANCEIRO - SELE√á√ÉO M√öLTIPLA
// ============================================

function renderFinancialTable(){
  const tbody=document.getElementById('financialTable');
  tbody.innerHTML='';
  const pendingAppts = appointments.filter(a=>!a.cancelled && !a.paid).sort((a,b)=>new Date(b.date)-new Date(a.date));
  
  pendingAppts.forEach(appt=>{
    const patient=patients.find(p=>p.id===appt.patientId);
    const row=document.createElement('tr');
    row.className='financial-row'+(selectedFinancial.has(appt.id)?' selected':'');
    row.onclick=(e)=>{
      if(e.target.type!=='checkbox')toggleFinancialSelection(appt.id);
    };
    row.innerHTML='<td><input type="checkbox" class="session-checkbox" '+(selectedFinancial.has(appt.id)?'checked':'')+' onchange="toggleFinancialSelection(\''+appt.id+'\')"></td><td>'+(patient?patient.name:'-')+'</td><td>'+formatDate(appt.date)+'</td><td>'+(appt.type==='laser'?'Laser':'Normal')+'</td><td>R$ '+parseFloat(appt.value||0).toFixed(2)+'</td><td>‚è≥ Pendente</td><td><button class="btn btn-primary" onclick="event.stopPropagation();togglePayment(\''+appt.id+'\')">Pagar</button></td>';
    tbody.appendChild(row);
  });
  
  const count = selectedFinancial.size;
  document.getElementById('selectedCount').textContent = count;
  document.getElementById('btnCobrarSelecionados').style.display = count > 0 ? 'inline-block' : 'none';
}

function toggleFinancialSelection(apptId){
  if(selectedFinancial.has(apptId))selectedFinancial.delete(apptId);
  else selectedFinancial.add(apptId);
  renderFinancialTable();
}

function toggleAllFinancial(){
  const pendingAppts = appointments.filter(a=>!a.cancelled && !a.paid);
  const allSelected = pendingAppts.every(a=>selectedFinancial.has(a.id));
  pendingAppts.forEach(a=>allSelected?selectedFinancial.delete(a.id):selectedFinancial.add(a.id));
  renderFinancialTable();
  document.getElementById('selectAllFinancial').checked = !allSelected;
}

function selectAllPending(){
  const pendingAppts = appointments.filter(a=>!a.cancelled && !a.paid);
  pendingAppts.forEach(a=>selectedFinancial.add(a.id));
  renderFinancialTable();
}

function clearSelection(){
  selectedFinancial.clear();
  renderFinancialTable();
  document.getElementById('selectAllFinancial').checked = false;
}

function sendSelectedPendingWhatsApp(){
  if(selectedFinancial.size===0){alert('Selecione pelo menos um atendimento!');return}
  
  const byPatient = {};
  let totalGeral = 0;
  
  selectedFinancial.forEach(apptId=>{
    const appt = appointments.find(a=>a.id===apptId);
    const patient = patients.find(p=>p.id===appt.patientId);
    if(!byPatient[appt.patientId]){
      byPatient[appt.patientId] = {patient: patient, appts: [], total: 0};
    }
    byPatient[appt.patientId].appts.push(appt);
    byPatient[appt.patientId].total += parseFloat(appt.value||0);
    totalGeral += parseFloat(appt.value||0);
  });
  
  const sig=getProfessionalSignature();
  
  if(Object.keys(byPatient).length === 1){
    const pid = Object.keys(byPatient)[0];
    const data = byPatient[pid];
    let msg='Ol√° '+data.patient.name+', tudo bem? üòä\n\n';
    msg+='Gostaria de lembrar que voc√™ possui os seguintes atendimentos em aberto:\n\n';
    data.appts.sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach((appt,idx)=>{
      msg+=(idx+1)+'. '+formatDate(appt.date)+' - '+appt.type+' - R$ '+parseFloat(appt.value||0).toFixed(2)+'\n';
    });
    msg+='\nüí∞ *Total: R$ '+data.total.toFixed(2)+'*\n\n';
    if(sig.pix)msg+='üí≥ Chave Pix para pagamento:\n*'+sig.pix+'*\n\n';
    msg+='Agrade√ßo a aten√ß√£o! Qualquer d√∫vida, estou √† disposi√ß√£o.'+(sig.name?'\n\nAtenciosamente,\n'+sig.name:'')+(sig.crefito?'\n'+sig.crefito:'');
    window.open('https://wa.me/55'+data.patient.phone.replace(/\D/g,'')+'?text='+encodeURIComponent(msg),'_blank');
  } else {
    let msgConfirm = 'Voc√™ selecionou atendimentos de '+Object.keys(byPatient).length+' pacientes diferentes:\n\n';
    Object.values(byPatient).forEach((data,idx)=>{
      msgConfirm+=(idx+1)+'. '+data.patient.name+' - R$ '+data.total.toFixed(2)+'\n';
    });
    msgConfirm+='\nDeseja enviar mensagem para todos? Ser√° aberta uma janela para cada paciente.';
    
    if(confirm(msgConfirm)){
      Object.values(byPatient).forEach(data=>{
        let msg='Ol√° '+data.patient.name+', tudo bem? üòä\n\n';
        msg+='Gostaria de lembrar que voc√™ possui os seguintes atendimentos em aberto:\n\n';
        data.appts.sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach((appt,idx)=>{
          msg+=(idx+1)+'. '+formatDate(appt.date)+' - '+appt.type+' - R$ '+parseFloat(appt.value||0).toFixed(2)+'\n';
        });
        msg+='\nüí∞ *Total: R$ '+data.total.toFixed(2)+'*\n\n';
        if(sig.pix)msg+='üí≥ Chave Pix para pagamento:\n*'+sig.pix+'*\n\n';
        msg+='Agrade√ßo a aten√ß√£o! Qualquer d√∫vida, estou √† disposi√ß√£o.'+(sig.name?'\n\nAtenciosamente,\n'+sig.name:'')+(sig.crefito?'\n'+sig.crefito:'');
        setTimeout(()=>{
          window.open('https://wa.me/55'+data.patient.phone.replace(/\D/g,'')+'?text='+encodeURIComponent(msg),'_blank');
        }, 500);
      });
    }
  }
}

function togglePayment(id){
  const appt=appointments.find(a=>a.id===id);
  appt.paid=!appt.paid;
  saveUserData();
  renderFinancialTable();
  updateFinancialSummary();
  renderCalendar();
  if(currentPatientId)renderPatientFinance();
}

function updateFinancialSummary(){
  const activeAppts=appointments.filter(a=>!a.cancelled);
  const received=activeAppts.filter(a=>a.paid).reduce((s,a)=>s+parseFloat(a.value||0),0);
  const pending=activeAppts.filter(a=>!a.paid).reduce((s,a)=>s+parseFloat(a.value||0),0);
  document.getElementById('totalReceived').textContent='R$ '+received.toFixed(2);
  document.getElementById('totalPending').textContent='R$ '+pending.toFixed(2);
  document.getElementById('totalSessions').textContent=activeAppts.length;
}

// ============================================
// AGENDA
// ============================================

function renderCalendar(){
  const year=currentDate.getFullYear(),month=currentDate.getMonth();
  document.getElementById('currentMonth').textContent=new Date(year,month).toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
  const firstDay=new Date(year,month,1).getDay(),daysInMonth=new Date(year,month+1,0).getDate();
  const calendar=document.getElementById('calendar');
  calendar.innerHTML='';
  const days=['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'];
  days.forEach(day=>{const div=document.createElement('div');div.className='calendar-header';div.textContent=day;calendar.appendChild(div)});
  for(let i=0;i<firstDay;i++)calendar.appendChild(document.createElement('div'));
  const today=new Date();
  for(let day=1;day<=daysInMonth;day++){
    const div=document.createElement('div');
    div.className='calendar-day';
    div.innerHTML='<strong>'+day+'</strong>';
    if(year===today.getFullYear()&&month===today.getMonth()&&day===today.getDate()){div.style.background='#2a9d8f';div.style.color='white'}
    const dayAppointments=appointments.filter(a=>{const parts=a.date.split('-');return parseInt(parts[0])===year&&(parseInt(parts[1])-1)===month&&parseInt(parts[2])===day});
    dayAppointments.forEach(appt=>{
      const patient=patients.find(p=>p.id===appt.patientId);
      const apptDiv=document.createElement('div');
      apptDiv.className='appointment'+(appt.cancelled?' cancelled':'');
      apptDiv.innerHTML='<span>'+appt.time+' '+(patient?patient.name.split(' ')[0]:'')+'</span>';
      const actions=document.createElement('div');
      actions.innerHTML='<button onclick="event.stopPropagation();editAppointment(\''+appt.id+'\')">‚úé</button> <button onclick="event.stopPropagation();toggleCancelAppointmentDirect(\''+appt.id+'\')">'+(appt.cancelled?'‚Ü©':'‚úï')+'</button>';
      apptDiv.appendChild(actions);
      div.appendChild(apptDiv);
    });
    div.onclick=()=>openAppointmentModal(year,month,day);
    calendar.appendChild(div);
  }
}

function changeMonth(delta){currentDate.setMonth(currentDate.getMonth()+delta);renderCalendar();}

function openAppointmentModal(year,month,day){
  currentApptId=null;
  document.getElementById('apptPatient').value='';
  document.getElementById('apptTime').value='';
  document.getElementById('apptValue').value='';
  document.getElementById('apptNotes').value='';
  document.getElementById('btnWhatsAppt').style.display='none';
  document.getElementById('btnToggleCancel').style.display='none';
  if(year!==undefined)document.getElementById('apptDate').value=year+'-'+String(month+1).padStart(2,'0')+'-'+String(day).padStart(2,'0');
  else document.getElementById('apptDate').value=new Date().toISOString().split('T')[0];
  document.getElementById('appointmentModal').classList.add('active');
}

function editAppointment(id){
  const appt=appointments.find(a=>a.id===id);
  currentApptId=id;
  document.getElementById('apptPatient').value=appt.patientId;
  document.getElementById('apptDate').value=appt.date;
  document.getElementById('apptTime').value=appt.time;
  document.getElementById('apptType').value=appt.type;
  document.getElementById('apptValue').value=appt.value;
  document.getElementById('apptNotes').value=appt.notes||'';
  document.getElementById('btnWhatsAppt').style.display='inline-block';
  document.getElementById('btnToggleCancel').style.display='inline-block';
  const btnCancel=document.getElementById('btnToggleCancel');
  if(appt.cancelled){btnCancel.textContent='‚Ü© Reativar';btnCancel.className='btn btn-success';}
  else{btnCancel.textContent='‚ùå Cancelar';btnCancel.className='btn btn-warning';}
  document.getElementById('appointmentModal').classList.add('active');
}

function saveAppointment(){
  const patientId=document.getElementById('apptPatient').value;
  if(!patientId){alert('Selecione um paciente!');return}
  const patient=patients.find(p=>p.id===patientId);
  const data={id:currentApptId||Date.now().toString(),patientId,date:document.getElementById('apptDate').value,time:document.getElementById('apptTime').value,type:document.getElementById('apptType').value,value:document.getElementById('apptValue').value||patient.defaultValue||0,notes:document.getElementById('apptNotes').value,paid:currentApptId?appointments.find(a=>a.id===currentApptId).paid:false,cancelled:currentApptId?appointments.find(a=>a.id===currentApptId).cancelled:false};
  if(currentApptId){const idx=appointments.findIndex(a=>a.id===currentApptId);appointments[idx]=data;}else{appointments.push(data);}
  saveUserData();
  closeModal('appointmentModal');
  renderCalendar();
  updateFinancialSummary();
}

function toggleCancelAppointment(){if(!currentApptId)return;toggleCancelAppointmentDirect(currentApptId);closeModal('appointmentModal');}
function toggleCancelAppointmentDirect(id){const appt=appointments.find(a=>a.id===id);appt.cancelled=!appt.cancelled;saveUserData();renderCalendar();updateFinancialSummary();}

function sendAppointmentWhatsApp(){
  if(!currentApptId)return;
  const appt=appointments.find(a=>a.id===currentApptId);
  const patient=patients.find(p=>p.id===appt.patientId);
  const sig=getProfessionalSignature();
  let msg='Ol√° '+patient.name+', tudo bem? üòä\n\nConfirma√ß√£o de agendamento:\n\nüìÖ Data: '+formatDate(appt.date)+'\n‚è∞ Hor√°rio: '+appt.time+'\nüè• Local: '+sig.clinic+'\n\n';
  if(!appt.cancelled){msg+='Estamos te aguardando!'+(sig.name?'\nAtenciosamente, '+sig.name:'')+(sig.crefito?'\n'+sig.crefito:'');}
  else{msg+='‚ö†Ô∏è ATEN√á√ÉO: Agendamento CANCELADO.';}
  window.open('https://wa.me/55'+patient.phone.replace(/\D/g,'')+'?text='+encodeURIComponent(msg),'_blank');
}

function loadPatientSelect(){
  const select=document.getElementById('apptPatient');
  select.innerHTML='<option value="">Selecione...</option>';
  patients.sort((a,b)=>a.name.localeCompare(b.name)).forEach(p=>{
    const opt=document.createElement('option');
    opt.value=p.id;
    opt.textContent=p.name;
    select.appendChild(opt);
  });
}

// ============================================
// PACIENTES
// ============================================

function renderPatients(){
  const list=document.getElementById('patientsList');
  list.innerHTML='';
  patients.forEach(p=>{
    const patientAppts=appointments.filter(a=>a.patientId===p.id&&!a.cancelled);
    const pending=patientAppts.filter(a=>!a.paid).length;
    const card=document.createElement('div');
    card.className='card';
    let html='<h3>'+p.name+'</h3><p>üì± '+p.phone+'</p><p>üí∞ R$ '+parseFloat(p.defaultValue||0).toFixed(2)+'</p>';
    if(pending>0)html+='<p style="color:#e76f51">‚ö†Ô∏è '+pending+' pendente(s)</p>';
    card.innerHTML=html;
    card.onclick=()=>openPatientModal(p.id);
    list.appendChild(card);
  });
}

function searchPatients(term){
  document.querySelectorAll('#patientsList .card').forEach(card=>{
    card.style.display=card.querySelector('h3').textContent.toLowerCase().includes(term.toLowerCase())?'block':'none';
  });
}

function openPatientModal(patientId){
  currentPatientId=patientId;
  selectedSessions.clear();
  document.getElementById('patientId').value='';
  document.getElementById('patientName').value='';
  document.getElementById('patientPhone').value='';
  document.getElementById('patientEmail').value='';
  document.getElementById('patientValue').value='';
  document.getElementById('patientComplaint').value='';
  showPatientTab('info');
  if(patientId){
    const p=patients.find(x=>x.id===patientId);
    document.getElementById('patientModalTitle').textContent='Editar Paciente';
    document.getElementById('patientId').value=p.id;
    document.getElementById('patientName').value=p.name;
    document.getElementById('patientPhone').value=p.phone;
    document.getElementById('patientEmail').value=p.email||'';
    document.getElementById('patientValue').value=p.defaultValue||'';
    document.getElementById('patientComplaint').value=p.complaint||'';
    document.getElementById('btnDeletePatient').style.display='block';
    renderPatientFinance();
    renderEvolutions();
  }else{
    document.getElementById('patientModalTitle').textContent='Novo Paciente';
    document.getElementById('btnDeletePatient').style.display='none';
  }
  document.getElementById('patientModal').classList.add('active');
}

function savePatient(){
  const id=document.getElementById('patientId').value;
  const data={id:id||Date.now().toString(),name:document.getElementById('patientName').value,phone:document.getElementById('patientPhone').value,email:document.getElementById('patientEmail').value,defaultValue:document.getElementById('patientValue').value,complaint:document.getElementById('patientComplaint').value};
  if(!data.name||!data.phone){alert('Preencha nome e telefone!');return}
  if(id){const idx=patients.findIndex(p=>p.id===id);patients[idx]=data;}else{patients.push(data);}
  saveUserData();
  closeModal('patientModal');
  renderPatients();
  loadPatientSelect();
}

function deletePatient(){
  if(!confirm('Excluir paciente e todos os dados?'))return;
  patients=patients.filter(p=>p.id!==currentPatientId);
  appointments=appointments.filter(a=>a.patientId!==currentPatientId);
  evolutions=evolutions.filter(e=>e.patientId!==currentPatientId);
  saveUserData();
  closeModal('patientModal');
  renderPatients();
  renderCalendar();
  updateFinancialSummary();
}

function showPatientTab(tab){
  document.querySelectorAll('#patientModal .tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('#patientModal .tab-content').forEach(t=>t.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('tab'+tab.charAt(0).toUpperCase()+tab.slice(1)).classList.add('active');
  if(tab==='financeiro')renderPatientFinance();
  if(tab==='evolucao')renderEvolutions();
}

function renderPatientFinance(){
  const patientAppts=appointments.filter(a=>a.patientId===currentPatientId&&!a.cancelled);
  const paid=patientAppts.filter(a=>a.paid).reduce((s,a)=>s+parseFloat(a.value||0),0);
  const pending=patientAppts.filter(a=>!a.paid).reduce((s,a)=>s+parseFloat(a.value||0),0);
  document.getElementById('patientPaid').textContent='R$ '+paid.toFixed(2);
  document.getElementById('patientPending').textContent='R$ '+pending.toFixed(2);
  const tbody=document.getElementById('patientFinanceTable');
  tbody.innerHTML='';
  patientAppts.sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(appt=>{
    const row=document.createElement('tr');
    row.className='session-row'+(selectedSessions.has(appt.id)?' selected':'');
    row.onclick=(e)=>{if(e.target.type!=='checkbox')toggleSessionSelection(appt.id);};
    row.innerHTML='<td><input type="checkbox" class="session-checkbox" '+(selectedSessions.has(appt.id)?'checked':'')+' onchange="toggleSessionSelection(\''+appt.id+'\')"></td><td>'+formatDate(appt.date)+'</td><td>'+appt.type+'</td><td>R$ '+parseFloat(appt.value||0).toFixed(2)+'</td><td>'+(appt.paid?'Pago':'Pendente')+'</td><td><button class="btn btn-primary" onclick="togglePayment(\''+appt.id+'\')">'+(appt.paid?'Desmarcar':'Pagar')+'</button></td>';
    tbody.appendChild(row);
  });
}

function toggleSessionSelection(apptId){
  if(selectedSessions.has(apptId))selectedSessions.delete(apptId);
  else selectedSessions.add(apptId);
  renderPatientFinance();
}

function toggleAllSessions(){
  const patientAppts=appointments.filter(a=>a.patientId===currentPatientId&&!a.cancelled&&!a.paid);
  const allSelected=patientAppts.every(a=>selectedSessions.has(a.id));
  patientAppts.forEach(a=>allSelected?selectedSessions.delete(a.id):selectedSessions.add(a.id));
  renderPatientFinance();
  document.getElementById('selectAllSessions').checked=!allSelected;
}

function sendPendingSessionsWhatsApp(){
  if(selectedSessions.size===0){alert('Selecione pelo menos uma sess√£o!');return}
  const patient=patients.find(p=>p.id===currentPatientId);
  const sig=getProfessionalSignature();
  let total=0,sessionsList='';
  const selectedAppts=appointments.filter(a=>selectedSessions.has(a.id)).sort((a,b)=>new Date(a.date)-new Date(b.date));
  selectedAppts.forEach((appt,index)=>{total+=parseFloat(appt.value||0);sessionsList+=(index+1)+'. '+formatDate(appt.date)+' - R$ '+parseFloat(appt.value||0).toFixed(2)+'\n';});
  let msg='Ol√° '+patient.name+', tudo bem? üòä\n\nSess√µes em aberto:\n\n'+sessionsList+'\nüí∞ *Total: R$ '+total.toFixed(2)+'*\n\n';
  if(sig.pix)msg+='üí≥ Chave Pix:\n*'+sig.pix+'*\n\n';
  msg+='Qualquer d√∫vida, estou √† disposi√ß√£o!'+(sig.name?'\n\nAtenciosamente,\n'+sig.name:'')+(sig.crefito?'\n'+sig.crefito:'');
  window.open('https://wa.me/55'+patient.phone.replace(/\D/g,'')+'?text='+encodeURIComponent(msg),'_blank');
}

function renderEvolutions(){
  const list=document.getElementById('evolutionsList');
  list.innerHTML='';
  evolutions.filter(e=>e.patientId===currentPatientId).sort((a,b)=>new Date(b.date+'T'+b.time)-new Date(a.date+'T'+a.time)).forEach(evo=>{
    const div=document.createElement('div');
    div.style.cssText='background:#f8f9fa;padding:15px;margin-bottom:10px;border-radius:8px;border-left:4px solid #2a9d8f';
    div.innerHTML='<small style="color:#666">'+formatDate(evo.date)+' √†s '+evo.time+'</small><p style="margin-top:5px">'+evo.text+'</p>';
    list.appendChild(div);
  });
}

function addEvolution(){
  const text=document.getElementById('newEvolution').value;
  if(!text.trim())return;
  const now=new Date();
  evolutions.push({id:Date.now().toString(),patientId:currentPatientId,date:now.toISOString().split('T')[0],time:now.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}),text});
  saveUserData();
  document.getElementById('newEvolution').value='';
  renderEvolutions();
}

function generatePatientReport(){
  const month=document.getElementById('reportMonthPatient').value;
  if(!month){alert('Selecione o m√™s!');return}
  const sig=getProfessionalSignature();
  const[year,mon]=month.split('-').map(Number);
  const patient=patients.find(p=>p.id===currentPatientId);
  const monthEvos=evolutions.filter(e=>e.patientId===currentPatientId&&e.date.startsWith(month)).sort((a,b)=>new Date(a.date)-new Date(b.date));
  const monthAppts=appointments.filter(a=>a.patientId===currentPatientId&&!a.cancelled&&a.date.startsWith(month));
  const monthName=new Date(year,mon-1).toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
  let report='RELAT√ìRIO MENSAL - '+sig.clinic.toUpperCase()+'\n'+(sig.name?sig.name+'\n':'')+(sig.crefito?sig.crefito+'\n':'')+'================================\n\nPaciente: '+patient.name+'\nPer√≠odo: '+monthName+'\n\nüìã RESUMO\nSess√µes: '+monthAppts.length+'\n\n';
  if(monthAppts.length>0){report+='Datas:\n';monthAppts.forEach(a=>{report+='‚Ä¢ '+formatDate(a.date)+' - '+a.time+'\n';});report+='\n';}
  report+='üìä EVOLU√á√ÉO\n\n';
  if(monthEvos.length===0)report+='Nenhuma evolu√ß√£o registrada.\n';
  else monthEvos.forEach((evo,i)=>{report+='Sess√£o '+(i+1)+' - '+formatDate(evo.date)+'\n'+evo.text+'\n--------------------------------\n\n';});
  report+='\n'+sig.clinic+(sig.name?'\n'+sig.name:'')+(sig.crefito?'\n'+sig.crefito:'');
  currentReport=report;
  document.getElementById('reportContent').textContent=report;
  document.getElementById('reportContainer').style.display='block';
}

// NOVA FUN√á√ÉO: Gerar PDF do relat√≥rio do paciente
function generatePatientReportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  const month = document.getElementById('reportMonthPatient').value;
  const [year, mon] = month.split('-').map(Number);
  const patient = patients.find(p => p.id === currentPatientId);
  const sig = getProfessionalSignature();
  const monthName = new Date(year, mon - 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
  
  // Configura√ß√µes de fonte e cores
  doc.setFont('helvetica');
  
  // Cabe√ßalho com fundo azul marinho
  doc.setFillColor(38, 70, 83);
  doc.rect(0, 0, 210, 40, 'F');
  
  // T√≠tulo da cl√≠nica
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(20);
  doc.setFont('helvetica', 'bold');
  doc.text(sig.clinic.toUpperCase(), 105, 20, { align: 'center' });
  
  // Nome do profissional
  doc.setFontSize(12);
  doc.setFont('helvetica', 'normal');
  doc.text(sig.name || 'Profissional', 105, 30, { align: 'center' });
  doc.text(sig.crefito || '', 105, 36, { align: 'center' });
  
  // Linha decorativa dourada
  doc.setDrawColor(244, 162, 97);
  doc.setLineWidth(2);
  doc.line(20, 45, 190, 45);
  
  // T√≠tulo do relat√≥rio
  doc.setTextColor(38, 70, 83);
  doc.setFontSize(16);
  doc.setFont('helvetica', 'bold');
  doc.text('RELAT√ìRIO MENSAL DE EVOLU√á√ÉO', 105, 60, { align: 'center' });
  
  // Informa√ß√µes do paciente
  doc.setFontSize(11);
  doc.setTextColor(100, 100, 100);
  doc.text('Paciente: ' + patient.name, 20, 75);
  doc.text('Per√≠odo: ' + monthName, 20, 82);
  doc.text('Data de emiss√£o: ' + new Date().toLocaleDateString('pt-BR'), 20, 89);
  
  // Linha separadora
  doc.setDrawColor(200, 200, 200);
  doc.setLineWidth(0.5);
  doc.line(20, 95, 190, 95);
  
  // Conte√∫do do relat√≥rio
  let yPos = 105;
  doc.setTextColor(50, 50, 50);
  doc.setFontSize(10);
  
  const monthEvos = evolutions.filter(e => e.patientId === currentPatientId && e.date.startsWith(month)).sort((a, b) => new Date(a.date) - new Date(b.date));
  const monthAppts = appointments.filter(a => a.patientId === currentPatientId && !a.cancelled && a.date.startsWith(month));
  
  // Resumo das sess√µes
  doc.setFont('helvetica', 'bold');
  doc.setTextColor(38, 70, 83);
  doc.text('RESUMO DAS SESS√ïES', 20, yPos);
  yPos += 10;
  
  doc.setFont('helvetica', 'normal');
  doc.setTextColor(50, 50, 50);
  doc.text('Total de sess√µes realizadas: ' + monthAppts.length, 20, yPos);
  yPos += 7;
  
  if (monthAppts.length > 0) {
    doc.text('Datas das sess√µes:', 20, yPos);
    yPos += 7;
    monthAppts.forEach(a => {
      doc.text('‚Ä¢ ' + formatDate(a.date) + ' √†s ' + a.time, 30, yPos);
      yPos += 5;
    });
  }
  
  yPos += 10;
  
  // Evolu√ß√µes
  doc.setFont('helvetica', 'bold');
  doc.setTextColor(38, 70, 83);
  doc.text('REGISTRO DE EVOLU√á√ÉO', 20, yPos);
  yPos += 10;
  
  doc.setFont('helvetica', 'normal');
  doc.setTextColor(50, 50, 50);
  
  if (monthEvos.length === 0) {
    doc.text('Nenhuma evolu√ß√£o registrada neste per√≠odo.', 20, yPos);
    yPos += 7;
  } else {
    monthEvos.forEach((evo, i) => {
      // Verifica se precisa de nova p√°gina
      if (yPos > 270) {
        doc.addPage();
        yPos = 20;
      }
      
      doc.setFont('helvetica', 'bold');
      doc.text('Sess√£o ' + (i + 1) + ' - ' + formatDate(evo.date), 20, yPos);
      yPos += 7;
      
      doc.setFont('helvetica', 'normal');
      const splitText = doc.splitTextToSize(evo.text, 170);
      doc.text(splitText, 20, yPos);
      yPos += (splitText.length * 5) + 5;
      
      // Linha separadora entre evolu√ß√µes
      doc.setDrawColor(230, 230, 230);
      doc.line(20, yPos, 190, yPos);
      yPos += 5;
    });
  }
  
  // Rodap√©
  const pageCount = doc.internal.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(8);
    doc.setTextColor(150, 150, 150);
    doc.text('¬© 2024 ' + sig.clinic + ' - Dra. Andresa Augusto - Proibida reprodu√ß√£o sem autoriza√ß√£o', 105, 290, { align: 'center' });
    doc.text('P√°gina ' + i + ' de ' + pageCount, 105, 295, { align: 'center' });
  }
  
  // Salva o PDF
  const fileName = 'Relatorio_' + patient.name.replace(/\s+/g, '_') + '_' + month + '.pdf';
  doc.save(fileName);
}

function copyReport(){
  navigator.clipboard.writeText(currentReport).then(()=>alert('Relat√≥rio copiado!'));
}

function sendReportWhatsApp(){
  const patient=patients.find(p=>p.id===currentPatientId);
  window.open('https://wa.me/55'+patient.phone.replace(/\D/g,'')+'?text='+encodeURIComponent(currentReport),'_blank');
}

// ============================================
// FLUXO DE CAIXA
// ============================================

function showCashFlowTab(tab){
  document.querySelectorAll('#fluxo .tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('#fluxo .tab-content').forEach(t=>t.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('cf'+tab.charAt(0).toUpperCase()+tab.slice(1)+'Tab').classList.add('active');
}

function renderCashFlow(){
  const month=document.getElementById('cashFlowMonth').value;
  if(!month)return;
  const entries=appointments.filter(a=>!a.cancelled&&a.paid&&a.date.startsWith(month));
  const monthExpenses=expenses.filter(e=>e.date.startsWith(month));
  const totalEntries=entries.reduce((s,a)=>s+parseFloat(a.value||0),0);
  const totalExits=monthExpenses.reduce((s,e)=>s+parseFloat(e.value||0),0);
  document.getElementById('cfEntries').textContent='R$ '+totalEntries.toFixed(2);
  document.getElementById('cfExits').textContent='R$ '+totalExits.toFixed(2);
  document.getElementById('cfBalance').textContent='R$ '+(totalEntries-totalExits).toFixed(2);
  const entriesBody=document.getElementById('entriesTable');
  entriesBody.innerHTML='';
  entries.sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(appt=>{
    const patient=patients.find(p=>p.id===appt.patientId);
    const row=document.createElement('tr');
    row.innerHTML='<td>'+formatDate(appt.date)+'</td><td>'+(patient?patient.name:'-')+'</td><td>'+appt.type+'</td><td>R$ '+parseFloat(appt.value||0).toFixed(2)+'</td>';
    entriesBody.appendChild(row);
  });
  const exitsBody=document.getElementById('exitsTable');
  exitsBody.innerHTML='';
  monthExpenses.sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(exp=>{
    const row=document.createElement('tr');
    row.innerHTML='<td>'+formatDate(exp.date)+'</td><td>'+exp.description+'</td><td>'+exp.category+'</td><td>R$ '+parseFloat(exp.value||0).toFixed(2)+'</td><td><button class="btn btn-danger" onclick="deleteExpense(\''+exp.id+'\')">üóë</button></td>';
    exitsBody.appendChild(row);
  });
  if(!document.getElementById('cfEntriesTab').classList.contains('active')&&!document.getElementById('cfExitsTab').classList.contains('active')){
    showCashFlowTab('entries');
  }
}

function deleteExpense(id){
  if(!confirm('Excluir despesa?'))return;
  expenses=expenses.filter(e=>e.id!==id);
  saveUserData();
  renderCashFlow();
}

function openExpenseModal(){
  document.getElementById('expenseDate').value=new Date().toISOString().split('T')[0];
  document.getElementById('expenseDesc').value='';
  document.getElementById('expenseValue').value='';
  document.getElementById('expenseModal').classList.add('active');
}

function saveExpense(){
  const data={
    id:Date.now().toString(),
    date:document.getElementById('expenseDate').value,
    description:document.getElementById('expenseDesc').value,
    category:document.getElementById('expenseCategory').value,
    value:document.getElementById('expenseValue').value
  };
  if(!data.date||!data.description||!data.value){alert('Preencha todos os campos!');return}
  expenses.push(data);
  saveUserData();
  closeModal('expenseModal');
  renderCashFlow();
}

// ============================================
// RELAT√ìRIOS
// ============================================

function renderReports(){
  const month=document.getElementById('reportMonth').value;
  if(!month)return;
  const monthAppts=appointments.filter(a=>!a.cancelled&&a.date.startsWith(month));
  const totalRevenue=monthAppts.reduce((s,a)=>s+parseFloat(a.value||0),0);
  document.getElementById('reportSessions').textContent=monthAppts.length;
  document.getElementById('reportRevenue').textContent='R$ '+totalRevenue.toFixed(2);
  const reportBody=document.getElementById('reportTable');
  reportBody.innerHTML='';
  const patientStats={};
  monthAppts.forEach(appt=>{
    if(!patientStats[appt.patientId]){patientStats[appt.patientId]={sessions:0,total:0};}
    patientStats[appt.patientId].sessions++;
    patientStats[appt.patientId].total+=parseFloat(appt.value||0);
  });
  Object.entries(patientStats).sort((a,b)=>b[1].sessions-a[1].sessions).forEach(([patientId,stats])=>{
    const patient=patients.find(p=>p.id===patientId);
    const row=document.createElement('tr');
    row.innerHTML='<td>'+(patient?patient.name:'Paciente removido')+'</td><td>'+stats.sessions+'</td><td>R$ '+stats.total.toFixed(2)+'</td>';
    reportBody.appendChild(row);
  });
}

// ============================================
// UTILIT√ÅRIOS
// ============================================

function closeModal(id){
  document.getElementById(id).classList.remove('active');
}

function formatDate(dateStr){
  const parts=dateStr.split('-');
  return parts[2]+'/'+parts[1]+'/'+parts[0];
}

// Fechar modal ao clicar fora
document.addEventListener('click',function(e){
  if(e.target.classList.contains('modal')){
    e.target.classList.remove('active');
  }
});

// Adicionar bot√£o de nova despesa na aba Fluxo de Caixa
document.addEventListener('DOMContentLoaded',function(){
  const fluxoSection=document.getElementById('fluxo');
  const tabs=fluxoSection.querySelector('.tabs');
  const btnExpense=document.createElement('button');
  btnExpense.className='btn btn-danger';
  btnExpense.textContent='+ Despesa';
  btnExpense.style.marginLeft='auto';
  btnExpense.onclick=openExpenseModal;
  tabs.appendChild(btnExpense);
});
</script>
</body>
</html>
