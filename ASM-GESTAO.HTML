<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASM Fisioterapia - Dra. Andresa Augusto</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f0f2f5; }
        .header { background: #264653; color: white; padding: 15px; }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; }
        .logo { font-size: 24px; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .nav-tabs { display: flex; gap: 10px; }
        .nav-tab { background: rgba(255,255,255,0.2); border: none; color: white; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        .nav-tab:hover, .nav-tab.active { background: white; color: #264653; }
        .main-content { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        .section { display: none; background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .section.active { display: block; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; margin: 5px; }
        .btn-primary { background: #2a9d8f; color: white; }
        .btn-success { background: #52b788; color: white; }
        .btn-danger { background: #e76f51; color: white; }
        .btn-whatsapp { background: #25d366; color: white; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 20px; }
        .calendar-day { background: #f8f9fa; min-height: 100px; padding: 10px; border-radius: 5px; cursor: pointer; border: 2px solid transparent; }
        .calendar-day:hover { border-color: #2a9d8f; }
        .appointment-slot { background: white; border-left: 3px solid #2a9d8f; padding: 5px; margin: 2px 0; border-radius: 4px; font-size: 12px; cursor: pointer; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; border-radius: 10px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-header { background: #264653; color: white; padding: 15px; border-radius: 10px 10px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .modal-close { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        .modal-body { padding: 20px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .tab { padding: 10px 20px; background: none; border: none; cursor: pointer; }
        .tab.active { color: #2a9d8f; border-bottom: 2px solid #2a9d8f; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: white; padding: 15px; border-radius: 8px; border: 2px solid #e2e8f0; cursor: pointer; margin-bottom: 10px; }
        .card:hover { border-color: #2a9d8f; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .summary-card { background: #2a9d8f; color: white; padding: 20px; border-radius: 10px; text-align: center; }
        .summary-card.danger { background: #e76f51; }
        .summary-card.success { background: #52b788; }
        .summary-value { font-size: 28px; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; }
        .report-content { background: #f8f9fa; padding: 20px; border-radius: 8px; white-space: pre-wrap; font-family: monospace; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">üè• ASM Fisioterapia</div>
            <nav class="nav-tabs">
                <button class="nav-tab active" onclick="showSection('agenda')">üìÖ Agenda</button>
                <button class="nav-tab" onclick="showSection('pacientes')">üë• Pacientes</button>
                <button class="nav-tab" onclick="showSection('financeiro')">üí∞ Financeiro</button>
                <button class="nav-tab" onclick="showSection('fluxo')">üìä Fluxo</button>
                <button class="nav-tab" onclick="showSection('relatorios')">üìà Relat√≥rios</button>
            </nav>
        </div>
    </div>

    <main class="main-content">
        <section id="agenda" class="section active">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <h2>Agenda</h2>
                <button class="btn btn-primary" onclick="openAppointmentModal()">+ Novo Agendamento</button>
            </div>
            <div style="display: flex; justify-content: center; gap: 20px; margin-bottom: 20px;">
                <button class="btn" onclick="changeMonth(-1)">‚Üê</button>
                <h3 id="currentMonth"></h3>
                <button class="btn" onclick="changeMonth(1)">‚Üí</button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </section>

        <section id="pacientes" class="section">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <h2>Pacientes</h2>
                <button class="btn btn-primary" onclick="openPatientModal()">+ Novo Paciente</button>
            </div>
            <input type="text" class="form-group" style="width: 100%; padding: 10px;" placeholder="Buscar..." oninput="searchPatients()">
            <div id="patientsGrid"></div>
        </section>

        <section id="financeiro" class="section">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <h2>Financeiro</h2>
                <button class="btn btn-success" onclick="exportToExcel()">üìä Excel</button>
            </div>
            <div class="summary-cards">
                <div class="summary-card success"><div class="summary-value" id="totalReceived">R$ 0,00</div><div>Recebido</div></div>
                <div class="summary-card danger"><div class="summary-value" id="totalPending">R$ 0,00</div><div>Pendente</div></div>
            </div>
            <table>
                <thead><tr><th>Paciente</th><th>Data</th><th>Valor</th><th>Status</th><th>A√ß√µes</th></tr></thead>
                <tbody id="financialTable"></tbody>
            </table>
        </section>

        <section id="fluxo" class="section">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <h2>Fluxo de Caixa</h2>
                <button class="btn btn-primary" onclick="openExpenseModal()">+ Despesa</button>
            </div>
            <input type="month" class="form-group" id="cashFlowMonth" onchange="renderCashFlow()">
            <div class="summary-cards">
                <div class="summary-card success"><div class="summary-value" id="cfEntries">R$ 0,00</div><div>Entradas</div></div>
                <div class="summary-card danger"><div class="summary-value" id="cfExits">R$ 0,00</div><div>Sa√≠das</div></div>
                <div class="summary-card"><div class="summary-value" id="cfBalance">R$ 0,00</div><div>Saldo</div></div>
            </div>
            <div class="tabs">
                <button class="tab active" onclick="showTab('cfEntriesTab', this)">Entradas</button>
                <button class="tab" onclick="showTab('cfExitsTab', this)">Despesas</button>
            </div>
            <div id="cfEntriesTab" class="tab-content active">
                <table><thead><tr><th>Data</th><th>Paciente</th><th>Valor</th></tr></thead><tbody id="entriesTable"></tbody></table>
            </div>
            <div id="cfExitsTab" class="tab-content">
                <table><thead><tr><th>Data</th><th>Descri√ß√£o</th><th>Valor</th><th>A√ß√µes</th></tr></thead><tbody id="exitsTable"></tbody></table>
            </div>
        </section>

        <section id="relatorios" class="section">
            <h2>Relat√≥rios</h2>
            <input type="month" class="form-group" id="reportMonth" onchange="renderReports()">
            <div class="summary-cards">
                <div class="summary-card"><div class="summary-value" id="reportSessions">0</div><div>Atendimentos</div></div>
                <div class="summary-card success"><div class="summary-value" id="reportRevenue">R$ 0,00</div><div>Faturamento</div></div>
            </div>
            <h3 style="margin-top: 20px;">Pacientes Atendidos</h3>
            <table><thead><tr><th>Paciente</th><th>Sess√µes</th><th>Total</th></tr></thead><tbody id="reportTable"></tbody></table>
        </section>
    </main>

    <!-- MODAL AGENDAMENTO -->
    <div class="modal-overlay" id="appointmentModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Agendamento</h3>
                <button class="modal-close" onclick="closeModal('appointmentModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group"><label>Paciente *</label><select id="apptPatient"></select></div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group"><label>Data *</label><input type="date" id="apptDate"></div>
                    <div class="form-group"><label>Hor√°rio *</label><input type="time" id="apptTime"></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Tipo</label>
                        <select id="apptType"><option value="normal">Normal</option><option value="laser">Laser</option><option value="avaliacao">Avalia√ß√£o</option></select>
                    </div>
                    <div class="form-group"><label>Valor (R$)</label><input type="number" id="apptValue" step="0.01"></div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="closeModal('appointmentModal')">Cancelar</button>
                    <button class="btn btn-whatsapp" id="btnWhatsAppt" onclick="sendApptWhatsApp()" style="display: none;">üì± WhatsApp</button>
                    <button class="btn btn-primary" onclick="saveAppointment()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PACIENTE - CORRIGIDO -->
    <div class="modal-overlay" id="patientModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="patientModalTitle">Novo Paciente</h3>
                <button class="modal-close" onclick="closeModal('patientModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <button class="tab active" onclick="showPatientTab('info', this)">Info</button>
                    <button class="tab" onclick="showPatientTab('financeiro', this)">Financeiro</button>
                    <button class="tab" onclick="showPatientTab('evolucao', this)">Evolu√ß√£o</button>
                    <button class="tab" onclick="showPatientTab('relatorio', this)">Relat√≥rio</button>
                </div>
                
                <div id="p-info" class="tab-content active">
                    <input type="hidden" id="patientId">
                    <div class="form-group"><label>Nome Completo *</label><input type="text" id="patientName" required></div>
                    <div class="form-group"><label>Telefone *</label><input type="tel" id="patientPhone" required></div>
                    <div class="form-group"><label>E-mail</label><input type="email" id="patientEmail"></div>
                    <div class="form-group"><label>Valor Padr√£o (R$)</label><input type="number" id="patientValue" step="0.01"></div>
                </div>
                
                <div id="p-financeiro" class="tab-content">
                    <div class="summary-cards">
                        <div class="summary-card success"><div class="summary-value" id="patientPaid">R$ 0</div><div>Pago</div></div>
                        <div class="summary-card danger"><div class="summary-value" id="patientPending">R$ 0</div><div>Pendente</div></div>
                    </div>
                    <table><thead><tr><th>Data</th><th>Valor</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody id="patientFinanceTable"></tbody></table>
                </div>
                
                <div id="p-evolucao" class="tab-content">
                    <div class="form-group">
                        <label>Nova Evolu√ß√£o</label>
                        <textarea id="newEvolution" rows="3"></textarea>
                        <button class="btn btn-primary" onclick="addEvolution()" style="margin-top: 10px;">Salvar</button>
                    </div>
                    <div id="evolutionsList"></div>
                </div>
                
                <div id="p-relatorio" class="tab-content">
                    <div class="form-group"><label>M√™s/Ano</label><input type="month" id="reportMonthPatient"></div>
                    <button class="btn btn-primary" onclick="generatePatientReport()">üü¢ Gerar Relat√≥rio</button>
                    <div id="reportContainer" style="display: none; margin-top: 20px;">
                        <div class="report-content" id="patientReportContent"></div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="btn btn-secondary" onclick="copyReport()">üìã Copiar</button>
                            <button class="btn btn-whatsapp" onclick="sendReportWhatsApp()">üì± WhatsApp</button>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button class="btn btn-danger" onclick="deletePatient()">Excluir</button>
                    <button class="btn btn-primary" onclick="savePatient()">Salvar Paciente</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DESPESA -->
    <div class="modal-overlay" id="expenseModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Despesa</h3>
                <button class="modal-close" onclick="closeModal('expenseModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group"><label>Data</label><input type="date" id="expenseDate"></div>
                <div class="form-group"><label>Descri√ß√£o</label><input type="text" id="expenseDesc"></div>
                <div class="form-group">
                    <label>Categoria</label>
                    <select id="expenseCategory"><option value="material">Material</option><option value="aluguel">Aluguel</option><option value="servicos">Servi√ßos</option><option value="outros">Outros</option></select>
                </div>
                <div class="form-group"><label>Valor (R$)</label><input type="number" id="expenseValue" step="0.01"></div>
                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button class="btn btn-secondary" onclick="closeModal('expenseModal')">Cancelar</button>
                    <button class="btn btn-primary" onclick="saveExpense()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let patients = JSON.parse(localStorage.getItem('asm_patients')) || [];
        let appointments = JSON.parse(localStorage.getItem('asm_appointments')) || [];
        let evolutions = JSON.parse(localStorage.getItem('asm_evolutions')) || [];
        let expenses = JSON.parse(localStorage.getItem('asm_expenses')) || [];
        let currentDate = new Date();
        let currentPatientId = null;
        let currentApptId = null;
        let currentReport = '';

        document.addEventListener('DOMContentLoaded', function() {
            renderCalendar();
            renderPatients();
            updateFinancialSummary();
            loadPatientSelect();
            let today = new Date().toISOString().slice(0, 7);
            document.getElementById('cashFlowMonth').value = today;
            document.getElementById('reportMonth').value = today;
        });

        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
            if (id === 'financeiro') renderFinancialTable();
            if (id === 'fluxo') renderCashFlow();
            if (id === 'relatorios') renderReports();
        }

        function showTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
        }

        function showPatientTab(tab, btn) {
            document.querySelectorAll('#patientModal .tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById('p-' + tab).classList.add('active');
            document.querySelectorAll('#patientModal .tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            if (tab === 'financeiro') renderPatientFinance();
            if (tab === 'evolucao') renderEvolutions();
        }

        function renderCalendar() {
            let year = currentDate.getFullYear();
            let month = currentDate.getMonth();
            document.getElementById('currentMonth').textContent = new Date(year, month).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            let firstDay = new Date(year, month, 1).getDay();
            let daysInMonth = new Date(year, month + 1, 0).getDate();
            let grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            let days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            days.forEach(day => {
                let div = document.createElement('div');
                div.style.cssText = 'text-align: center; font-weight: bold; padding: 10px; background: #264653; color: white;';
                div.textContent = day;
                grid.appendChild(div);
            });
            
            for (let i = 0; i < firstDay; i++) grid.appendChild(document.createElement('div'));
            
            let today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                let div = document.createElement('div');
                div.className = 'calendar-day';
                div.innerHTML = '<strong>' + day + '</strong>';
                if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                    div.style.background = '#2a9d8f';
                    div.style.color = 'white';
                }
                
                let dayAppts = appointments.filter(a => {
                    let parts = a.date.split('-');
                    return parseInt(parts[0]) === year && (parseInt(parts[1]) - 1) === month && parseInt(parts[2]) === day;
                });
                
                dayAppts.forEach(appt => {
                    let patient = patients.find(p => p.id === appt.patientId);
                    let slot = document.createElement('div');
                    slot.className = 'appointment-slot';
                    slot.textContent = appt.time + ' ' + (patient ? patient.name.split(' ')[0] : '');
                    slot.onclick = function(e) { e.stopPropagation(); editAppointment(appt.id); };
                    div.appendChild(slot);
                });
                
                div.onclick = function() { openAppointmentModal(year, month, day); };
                grid.appendChild(div);
            }
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        }

        function renderPatients() {
            let grid = document.getElementById('patientsGrid');
            grid.innerHTML = '';
            patients.forEach(p => {
                let appts = appointments.filter(a => a.patientId === p.id);
                let pending = appts.filter(a => !a.paid).length;
                let card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = '<h3>' + p.name + '</h3><p>üì± ' + p.phone + '</p><p>üí∞ R$ ' + parseFloat(p.defaultValue || 0).toFixed(2) + '</p>' + (pending > 0 ? '<p style="color: #e76f51;">‚ö†Ô∏è ' + pending + ' pendente(s)</p>' : '');
                card.onclick = function() { openPatientModal(p.id); };
                grid.appendChild(card);
            });
        }

        function searchPatients() {
            let term = document.getElementById('patientSearch').value.toLowerCase();
            document.querySelectorAll('#patientsGrid .card').forEach(card => {
                card.style.display = card.querySelector('h3').textContent.toLowerCase().includes(term) ? 'block' : 'none';
            });
        }

        // CORRE√á√ÉO PRINCIPAL AQUI
        function openPatientModal(id) {
            currentPatientId = id || null;
            
            // Resetar campos
            document.getElementById('patientId').value = '';
            document.getElementById('patientName').value = '';
            document.getElementById('patientPhone').value = '';
            document.getElementById('patientEmail').value = '';
            document.getElementById('patientValue').value = '';
            
            // Resetar abas para a primeira
            document.querySelectorAll('#patientModal .tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#patientModal .tab').forEach(t => t.classList.remove('active'));
            document.getElementById('p-info').classList.add('active');
            document.querySelector('#patientModal .tab').classList.add('active');
            
            if (id) {
                let p = patients.find(x => x.id === id);
                document.getElementById('patientModalTitle').textContent = 'Editar Paciente';
                document.getElementById('patientId').value = p.id;
                document.getElementById('patientName').value = p.name;
                document.getElementById('patientPhone').value = p.phone;
                document.getElementById('patientEmail').value = p.email || '';
                document.getElementById('patientValue').value = p.defaultValue || '';
            } else {
                document.getElementById('patientModalTitle').textContent = 'Novo Paciente';
            }
            
            // ABRIR MODAL - GARANTIDO
            document.getElementById('patientModal').classList.add('active');
        }

        function savePatient() {
            let id = document.getElementById('patientId').value;
            let data = {
                id: id || Date.now().toString(),
                name: document.getElementById('patientName').value,
                phone: document.getElementById('patientPhone').value,
                email: document.getElementById('patientEmail').value,
                defaultValue: document.getElementById('patientValue').value
            };
            if (!data.name || !data.phone) { alert('Preencha nome e telefone!'); return; }
            if (id) { let idx = patients.findIndex(p => p.id === id); patients[idx] = data; } 
            else { patients.push(data); }
            localStorage.setItem('asm_patients', JSON.stringify(patients));
            closeModal('patientModal');
            renderPatients();
            loadPatientSelect();
        }

        function deletePatient() {
            if (!confirm('Excluir paciente e todos os dados?')) return;
            patients = patients.filter(p => p.id !== currentPatientId);
            appointments = appointments.filter(a => a.patientId !== currentPatientId);
            evolutions = evolutions.filter(e => e.patientId !== currentPatientId);
            localStorage.setItem('asm_patients', JSON.stringify(patients));
            localStorage.setItem('asm_appointments', JSON.stringify(appointments));
            localStorage.setItem('asm_evolutions', JSON.stringify(evolutions));
            closeModal('patientModal');
            renderPatients();
            renderCalendar();
            updateFinancialSummary();
        }

        function openAppointmentModal(year, month, day) {
            currentApptId = null;
            document.getElementById('apptPatient').value = '';
            document.getElementById('apptTime').value = '';
            document.getElementById('apptValue').value = '';
            document.getElementById('btnWhatsAppt').style.display = 'none';
            if (year !== undefined) {
                document.getElementById('apptDate').value = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
            } else {
                document.getElementById('apptDate').value = new Date().toISOString().split('T')[0];
            }
            document.getElementById('appointmentModal').classList.add('active');
        }

        function editAppointment(id) {
            let appt = appointments.find(a => a.id === id);
            currentApptId = id;
            document.getElementById('apptPatient').value = appt.patientId;
            document.getElementById('apptDate').value = appt.date;
            document.getElementById('apptTime').value = appt.time;
            document.getElementById('apptType').value = appt.type;
            document.getElementById('apptValue').value = appt.value;
            document.getElementById('btnWhatsAppt').style.display = 'inline-block';
            document.getElementById('appointmentModal').classList.add('active');
        }

        function saveAppointment() {
            let patientId = document.getElementById('apptPatient').value;
            if (!patientId) { alert('Selecione um paciente!'); return; }
            let patient = patients.find(p => p.id === patientId);
            let data = {
                id: currentApptId || Date.now().toString(),
                patientId: patientId,
                date: document.getElementById('apptDate').value,
                time: document.getElementById('apptTime').value,
                type: document.getElementById('apptType').value,
                value: parseFloat(document.getElementById('apptValue').value) || parseFloat(patient.defaultValue) || 0,
                paid: currentApptId ? appointments.find(a => a.id === currentApptId).paid : false
            };
            if (currentApptId) { let idx = appointments.findIndex(a => a.id === currentApptId); appointments[idx] = data; } 
            else { appointments.push(data); }
            localStorage.setItem('asm_appointments', JSON.stringify(appointments));
            closeModal('appointmentModal');
            renderCalendar();
            updateFinancialSummary();
        }

        function sendApptWhatsApp() {
            if (!currentApptId) return;
            let appt = appointments.find(a => a.id === currentApptId);
            let patient = patients.find(p => p.id === appt.patientId);
            let msg = 'Ol√° ' + patient.name + ',\n\nLembramos do seu agendamento na ASM Fisioterapia - Dra. Andresa Augusto.\n\nüìÖ Data: ' + formatDate(appt.date) + '\n‚è∞ Hor√°rio: ' + appt.time + '\n\nAguardamos voc√™! üíö';
            window.open('https://wa.me/55' + patient.phone.replace(/\D/g, '') + '?text=' + encodeURIComponent(msg), '_blank');
        }

        function renderFinancialTable() {
            let tbody = document.getElementById('financialTable');
            tbody.innerHTML = '';
            appointments.slice().sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(appt => {
                let patient = patients.find(p => p.id === appt.patientId);
                let row = document.createElement('tr');
                row.innerHTML = '<td>' + (patient ? patient.name : '-') + '</td><td>' + formatDate(appt.date) + '</td><td>R$ ' + parseFloat(appt.value).toFixed(2) + '</td><td>' + (appt.paid ? '‚úÖ Pago' : '‚è≥ Pendente') + '</td><td><button class="btn btn-primary" onclick="togglePayment(\'' + appt.id + '\')">' + (appt.paid ? 'Desmarcar' : 'Pagar') + '</button></td>';
                tbody.appendChild(row);
            });
        }

        function renderPatientFinance() {
            let appts = appointments.filter(a => a.patientId === currentPatientId);
            let paid = appts.filter(a => a.paid).reduce((s, a) => s + parseFloat(a.value), 0);
            let pending = appts.filter(a => !a.paid).reduce((s, a) => s + parseFloat(a.value), 0);
            document.getElementById('patientPaid').textContent = 'R$ ' + paid.toFixed(2);
            document.getElementById('patientPending').textContent = 'R$ ' + pending.toFixed(2);
            let tbody = document.getElementById('patientFinanceTable');
            tbody.innerHTML = '';
            appts.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(appt => {
                let row = document.createElement('tr');
                row.innerHTML = '<td>' + formatDate(appt.date) + '</td><td>R$ ' + parseFloat(appt.value).toFixed(2) + '</td><td>' + (appt.paid ? 'Pago' : 'Pendente') + '</td><td><button class="btn btn-primary" onclick="togglePayment(\'' + appt.id + '\')">' + (appt.paid ? 'Desmarcar' : 'Pagar') + '</button></td>';
                tbody.appendChild(row);
            });
        }

        function updateFinancialSummary() {
            let received = appointments.filter(a => a.paid).reduce((s, a) => s + parseFloat(a.value), 0);
            let pending = appointments.filter(a => !a.paid).reduce((s, a) => s + parseFloat(a.value), 0);
            document.getElementById('totalReceived').textContent = 'R$ ' + received.toFixed(2);
            document.getElementById('totalPending').textContent = 'R$ ' + pending.toFixed(2);
        }

        function togglePayment(id) {
            let appt = appointments.find(a => a.id === id);
            appt.paid = !appt.paid;
            localStorage.setItem('asm_appointments', JSON.stringify(appointments));
            renderFinancialTable();
            updateFinancialSummary();
            renderCalendar();
            if (currentPatientId) renderPatientFinance();
        }

        function renderEvolutions() {
            let list = document.getElementById('evolutionsList');
            list.innerHTML = '';
            evolutions.filter(e => e.patientId === currentPatientId).sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(evo => {
                let div = document.createElement('div');
                div.style.cssText = 'background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #2a9d8f;';
                div.innerHTML = '<small style="color: #666;">' + formatDate(evo.date) + ' ' + evo.time + '</small><p style="margin-top: 5px;">' + evo.text + '</p>';
                list.appendChild(div);
            });
        }

        function addEvolution() {
            let text = document.getElementById('newEvolution').value;
            if (!text.trim()) return;
            let now = new Date();
            evolutions.push({
                id: Date.now().toString(),
                patientId: currentPatientId,
                date: now.toISOString().split('T')[0],
                time: now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                text: text
            });
            localStorage.setItem('asm_evolutions', JSON.stringify(evolutions));
            document.getElementById('newEvolution').value = '';
            renderEvolutions();
        }

        function generatePatientReport() {
            let month = document.getElementById('reportMonthPatient').value;
            if (!month) { alert('Selecione o m√™s!'); return; }
            let parts = month.split('-');
            let year = parseInt(parts[0]);
            let mon = parseInt(parts[1]);
            let patient = patients.find(p => p.id === currentPatientId);
            let monthEvos = evolutions.filter(e => e.patientId === currentPatientId && parseInt(e.date.split('-')[0]) === year && parseInt(e.date.split('-')[1]) === mon).sort((a, b) => new Date(a.date) - new Date(b.date));
            let monthAppts = appointments.filter(a => a.patientId === currentPatientId && parseInt(a.date.split('-')[0]) === year && parseInt(a.date.split('-')[1]) === mon);
            let monthName = new Date(year, mon - 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            
            let report = 'RELAT√ìRIO MENSAL - ASM FISIOTERAPIA\nDra. Andresa Augusto\n================================\n\nPaciente: ' + patient.name + '\nPer√≠odo: ' + monthName + '\n\nüìã RESUMO\nSess√µes: ' + monthAppts.length + '\n\n';
            if (monthAppts.length > 0) {
                report += 'Datas:\n';
                monthAppts.forEach(a => { report += '‚Ä¢ ' + formatDate(a.date) + ' - ' + a.time + '\n'; });
                report += '\n';
            }
            report += 'üìä EVOLU√á√ïES\n\n';
            if (monthEvos.length === 0) report += 'Nenhuma evolu√ß√£o registrada.\n';
            else monthEvos.forEach((evo, i) => { report += 'Sess√£o ' + (i + 1) + ' - ' + formatDate(evo.date) + '\n' + evo.text + '\n--------------------------------\n\n'; });
            report += '\nüíö ASM Fisioterapia';
            
            currentReport = report;
            document.getElementById('patientReportContent').textContent = report;
            document.getElementById('reportContainer').style.display = 'block';
        }

        function copyReport() { navigator.clipboard.writeText(currentReport).then(() => alert('Copiado!')); }
        function sendReportWhatsApp() { let patient = patients.find(p => p.id === currentPatientId); window.open('https://wa.me/55' + patient.phone.replace(/\D/g, '') + '?text=' + encodeURIComponent(currentReport), '_blank'); }

        function openExpenseModal() { document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0]; document.getElementById('expenseModal').classList.add('active'); }
        function saveExpense() {
            let data = { id: Date.now().toString(), date: document.getElementById('expenseDate').value, description: document.getElementById('expenseDesc').value, category: document.getElementById('expenseCategory').value, value: parseFloat(document.getElementById('expenseValue').value) };
            if (!data.date || !data.description || !data.value) { alert('Preencha todos os campos!'); return; }
            expenses.push(data);
            localStorage.setItem('asm_expenses', JSON.stringify(expenses));
            closeModal('expenseModal');
            document.getElementById('expenseDesc').value = '';
            document.getElementById('expenseValue').value = '';
            renderCashFlow();
        }

        function renderCashFlow() {
            let month = document.getElementById('cashFlowMonth').value;
            if (!month) return;
            let parts = month.split('-');
            let year = parseInt(parts[0]);
            let mon = parseInt(parts[1]);
            let entries = appointments.filter(a => a.paid && parseInt(a.date.split('-')[0]) === year && parseInt(a.date.split('-')[1]) === mon);
            let exits = expenses.filter(e => parseInt(e.date.split('-')[0]) === year && parseInt(e.date.split('-')[1]) === mon);
            let totalEntries = entries.reduce((s, a) => s + parseFloat(a.value), 0);
            let totalExits = exits.reduce((s, e) => s + parseFloat(e.value), 0);
            document.getElementById('cfEntries').textContent = 'R$ ' + totalEntries.toFixed(2);
            document.getElementById('cfExits').textContent = 'R$ ' + totalExits.toFixed(2);
            document.getElementById('cfBalance').textContent = 'R$ ' + (totalEntries - totalExits).toFixed(2);
            
            let entriesBody = document.getElementById('entriesTable');
            entriesBody.innerHTML = '';
            entries.forEach(a => { let p = patients.find(x => x.id === a.patientId); let row = document.createElement('tr'); row.innerHTML = '<td>' + formatDate(a.date) + '</td><td>' + (p ? p.name : '-') + '</td><td>R$ ' + parseFloat(a.value).toFixed(2) + '</td>'; entriesBody.appendChild(row); });
            
            let exitsBody = document.getElementById('exitsTable');
            exitsBody.innerHTML = '';
            exits.forEach(e => { let row = document.createElement('tr'); row.innerHTML = '<td>' + formatDate(e.date) + '</td><td>' + e.description + '</td><td>R$ ' + parseFloat(e.value).toFixed(2) + '</td><td><button class="btn btn-danger" onclick="deleteExpense(\'' + e.id + '\')">Excluir</button></td>'; exitsBody.appendChild(row); });
        }

        function deleteExpense(id) { if (!confirm('Excluir despesa?')) return; expenses = expenses.filter(e => e.id !== id); localStorage.setItem('asm_expenses', JSON.stringify(expenses)); renderCashFlow(); }

        function renderReports() {
            let month = document.getElementById('reportMonth').value;
            if (!month) return;
            let parts = month.split('-');
            let year = parseInt(parts[0]);
            let mon = parseInt(parts[1]);
            let monthAppts = appointments.filter(a => parseInt(a.date.split('-')[0]) === year && parseInt(a.date.split('-')[1]) === mon);
            let revenue = monthAppts.filter(a => a.paid).reduce((s, a) => s + parseFloat(a.value), 0);
            document.getElementById('reportSessions').textContent = monthAppts.length;
            document.getElementById('reportRevenue').textContent = 'R$ ' + revenue.toFixed(2);
            let stats = {};
            monthAppts.forEach(a => { if (!stats[a.patientId]) stats[a.patientId] = { count: 0, total: 0 }; stats[a.patientId].count++; if (a.paid) stats[a.patientId].total += parseFloat(a.value); });
            let tbody = document.getElementById('reportTable');
            tbody.innerHTML = '';
            for (let pid in stats) { let p = patients.find(x => x.id === pid); let s = stats[pid]; let row = document.createElement('tr'); row.innerHTML = '<td>' + (p ? p.name : '-') + '</td><td>' + s.count + '</td><td>R$ ' + s.total.toFixed(2) + '</td>'; tbody.appendChild(row); }
        }

        function exportToExcel() {
            let csv = 'Paciente;Data;Servico;Valor;Status\n';
            appointments.forEach(a => { let p = patients.find(x => x.id === a.patientId); csv += (p ? p.name : '-') + ';' + formatDate(a.date) + ';' + a.type + ';' + parseFloat(a.value).toFixed(2) + ';' + (a.paid ? 'Pago' : 'Pendente') + '\n'; });
            let blob = new Blob(['\uFEFF' + csv], { type: 'text/csv' });
            let link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ASM_Financeiro_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
        }

        function formatDate(dateStr) { if (!dateStr) return ''; let parts = dateStr.split('-'); return parts[2] + '/' + parts[1] + '/' + parts[0]; }
        function loadPatientSelect() { let select = document.getElementById('apptPatient'); select.innerHTML = '<option value="">Selecione...</option>'; patients.forEach(p => { let opt = document.createElement('option'); opt.value = p.id; opt.textContent = p.name; select.appendChild(opt); }); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        document.querySelectorAll('.modal-overlay').forEach(m => { m.onclick = function(e) { if (e.target === this) this.classList.remove('active'); }; });
    </script>
</body>
</html>